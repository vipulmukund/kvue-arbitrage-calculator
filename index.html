<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Updating KVUE/KMB Arbitrage Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 500px; margin: 0 auto; padding: 25px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
        .data-source, .exchange-rate { background-color: #ecf0f1; padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; font-size: 0.9em; }
        .result-box { background-color: #e8f7f7; border: 1px solid #3498db; padding: 15px; border-radius: 4px; font-size: 1.1em; }
        .result-box p { margin: 5px 0; }
        .price { font-weight: bold; color: #1e8449; }
        .positive { color: green; font-weight: bold; }
        .negative { color: red; font-weight: bold; }
        .timestamp { font-size: 0.75em; color: #7f8c8d; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¡ Auto Arbitrage Calculator (KVUE/KMB)</h2>

    <div class="data-source">
        <p>Data Source: **Financial Modeling Prep API** (Updates every 15 minutes)</p>
        <p class="timestamp">Mode: <span id="envMode">--</span></p>
        <p class="timestamp">Last Updated: <span id="lastUpdated">--</span></p>
    </div>

    <div class="exchange-rate">
        <p><strong>Merger Terms (Fixed):</strong></p>
        <p>KVUE Share = $3.50 Cash + 0.14625 KMB Shares</p>
    </div>

    <div class="result-box">
        <p><strong>Kenvue (KVUE) Price:</strong> $<span id="kvuePriceDisplay" class="price">--</span></p>
        <p><strong>Kimberly-Clark (KMB) Price:</strong> $<span id="kmbPriceDisplay" class="price">--</span></p>
        <hr>
        <p><strong>Deal Implied Value for KVUE:</strong> $<span id="dealImpliedValue">--</span></p>
        <p><strong>Arbitrage Spread:</strong> <span id="arbitrageSpread" class="positive">--%</span></p>
    </div>
</div>

<script>
    // --- Configuration ---
    const KVUE_TICKER = 'KVUE';
    const KMB_TICKER = 'KMB';
    const CASH_COMPONENT = 3.50;
    const EXCHANGE_RATIO = 0.14625;
    
    // Environment detection
    const IS_PRODUCTION = window.location.hostname !== 'localhost' && 
                          window.location.hostname !== '127.0.0.1' && 
                          window.location.protocol !== 'file:';
    
    // Function to get the appropriate API URL based on environment
    function getApiUrl(ticker) {
        if (IS_PRODUCTION) {
            // On Vercel: use serverless function (secure)
            return `/api/stock-price?ticker=${ticker}`;
        } else {
            // Local development: use Yahoo Finance alternative API (free, no key needed)
            return `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
        }
    }

    // --- Core Calculation Function ---
    function calculateSpread(kvuePrice, kmbPrice) {
        if (!kvuePrice || !kmbPrice) {
            console.error("Missing stock prices for calculation.");
            return { impliedValue: NaN, spreadPercent: NaN };
        }

        // Calculation 1: Deal Implied Value
        const impliedValue = CASH_COMPONENT + (kmbPrice * EXCHANGE_RATIO);

        // Calculation 2: Arbitrage Spread (%)
        const spreadAbsolute = impliedValue - kvuePrice;
        const spreadPercent = (spreadAbsolute / kvuePrice) * 100;

        return { impliedValue, spreadPercent };
    }

    // --- Fetch Data and Update UI ---
    async function fetchDataAndCalculate() {
        document.getElementById('lastUpdated').textContent = 'Fetching new data...';
        
        try {
            // Fetch options with User-Agent header for Yahoo Finance
            const fetchOptions = IS_PRODUCTION ? {} : {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
                }
            };
            
            // Fetch KVUE Price
            const kvueResponse = await fetch(getApiUrl(KVUE_TICKER), fetchOptions);
            if (!kvueResponse.ok) {
                throw new Error(`HTTP error! status: ${kvueResponse.status}`);
            }
            const kvueData = await kvueResponse.json();
            
            // Parse price based on API response format
            let kvuePrice;
            if (IS_PRODUCTION) {
                // Serverless function response (FMP format)
                kvuePrice = kvueData[0]?.price;
            } else {
                // Yahoo Finance format
                kvuePrice = kvueData.chart?.result?.[0]?.meta?.regularMarketPrice;
            }

            // Fetch KMB Price
            const kmbResponse = await fetch(getApiUrl(KMB_TICKER), fetchOptions);
            if (!kmbResponse.ok) {
                throw new Error(`HTTP error! status: ${kmbResponse.status}`);
            }
            const kmbData = await kmbResponse.json();
            
            // Parse price based on API response format
            let kmbPrice;
            if (IS_PRODUCTION) {
                // Serverless function response (FMP format)
                kmbPrice = kmbData[0]?.price;
            } else {
                // Yahoo Finance format
                kmbPrice = kmbData.chart?.result?.[0]?.meta?.regularMarketPrice;
            }

            // Update UI with prices
            if (kvuePrice) document.getElementById('kvuePriceDisplay').textContent = kvuePrice.toFixed(2);
            if (kmbPrice) document.getElementById('kmbPriceDisplay').textContent = kmbPrice.toFixed(2);
            
            // Perform Calculation
            const { impliedValue, spreadPercent } = calculateSpread(kvuePrice, kmbPrice);

            // Update UI with results
            const impliedValueElement = document.getElementById('dealImpliedValue');
            const spreadElement = document.getElementById('arbitrageSpread');
            
            impliedValueElement.textContent = impliedValue.toFixed(2);
            spreadElement.textContent = spreadPercent.toFixed(2) + '%';
            
            spreadElement.classList.remove('positive', 'negative');
            if (spreadPercent > 0) {
                spreadElement.classList.add('positive');
            } else if (spreadPercent < 0) {
                spreadElement.classList.add('negative');
            }

            // Update Timestamp
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

        } catch (error) {
            console.error('Error fetching stock data:', error);
            console.error('Error details:', error.message);
            console.error('Is Production?', IS_PRODUCTION);
            console.error('KVUE URL:', getApiUrl(KVUE_TICKER));
            
            document.getElementById('lastUpdated').textContent = `Error: ${error.message}`;
            // Clear or set error message for prices/results
            document.getElementById('kvuePriceDisplay').textContent = 'N/A';
            document.getElementById('kmbPriceDisplay').textContent = 'N/A';
            document.getElementById('dealImpliedValue').textContent = 'N/A';
            document.getElementById('arbitrageSpread').textContent = 'N/A';
        }
    }

    // --- Auto-Refresh Setup ---
    const REFRESH_INTERVAL_MS = 15 * 60 * 1000; // 15 minutes in milliseconds

    // Display environment mode
    document.getElementById('envMode').textContent = IS_PRODUCTION ? 'ðŸ”’ Production (Secure)' : 'ðŸ”§ Development';
    
    // 1. Fetch data immediately on load
    fetchDataAndCalculate();

    // 2. Set interval for automatic refreshing
    setInterval(fetchDataAndCalculate, REFRESH_INTERVAL_MS);
</script>

</body>
</html>